<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem KoAktif! - SJKC Kg Baru Pajam</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom styles for messages/modals */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px;
            border-radius: 12px; /* More rounded */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); /* Stronger shadow */
            z-index: 1000;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-family: 'Inter', sans-serif; /* Consistent font */
        }
        .message-box.error {
            background-color: #ef4444; /* Tailwind red-500 */
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }

        /* Styling for active navigation tab */
        .tab-button.active {
            @apply bg-indigo-800 text-white shadow-inner; /* Darker indigo for active */
        }
        /* Style for selected murid list items */
        .murid-item {
            @apply flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm text-sm transition-all duration-200 ease-in-out;
        }
        .remove-murid-button {
            @apply p-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200 focus:outline-none transition-all duration-150 ease-in-out;
        }
        /* Style for carousel navigation buttons */
        .carousel-nav-button {
            @apply px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-150 ease-in-out shadow-md; /* Added shadow */
        }
        .carousel-nav-button:disabled {
            @apply bg-gray-400 text-gray-600 cursor-not-allowed shadow-none; /* Darker disabled */
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem; /* More padding */
            border-radius: 1.5rem; /* More rounded */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); /* Deeper shadow */
            max-width: 85%; /* Slightly wider */
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px); /* Initial slight move down */
            transition: transform 0.3s ease-out;
        }
        .modal.show .modal-content {
            transform: translateY(0); /* Move to original position */
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.8rem; /* Larger close button */
            background: none;
            border: none;
            cursor: pointer;
            color: #ef4444; /* red-500 */
            transition: transform 0.2s ease-in-out;
        }
        .close-button:hover {
            transform: rotate(90deg); /* Spin on hover */
        }

        /* Table styling for student dashboard */
        .student-table, .teacher-table {
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners on cells */
            border-spacing: 0; /* Remove default cell spacing */
            margin-top: 1rem;
            border-radius: 0.75rem; /* Rounded table corners */
            overflow: hidden; /* Hide overflowing content for rounded corners */
        }
        .student-table th, .student-table td, .teacher-table th, .teacher-table td {
            padding: 1rem 1.25rem; /* More padding */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
        }
        .student-table th, .teacher-table th {
            background-color: #f1f5f9; /* slate-100 */
            font-weight: 700; /* Bolder font */
            color: #334155; /* slate-700 */
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em; /* Slightly more spaced */
        }
        .student-table tbody tr:hover, .teacher-table tbody tr:hover {
            background-color: #e0e7ff; /* indigo-100, subtle hover */
            cursor: pointer;
        }
        .teacher-table tbody tr:hover .view-teacher-data {
            @apply bg-blue-600; /* Darker blue on row hover */
        }

        /* Input and Select styling */
        input[type="text"], input[type="email"], input[type="password"], select {
            @apply p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-150 shadow-sm;
            font-family: 'Inter', sans-serif;
        }
        button {
            @apply transition-all duration-200 ease-in-out transform;
        }
        button:hover {
            @apply -translate-y-0.5 shadow-lg;
        }
        button:active {
            @apply translate-y-0 shadow-md;
        }
    </style>
</head>
<body class="font-sans bg-gradient-to-br from-slate-50 to-indigo-100 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Message Box -->
    <div id="message-box" class="message-box rounded-lg">
        <p id="message-text" class="font-medium"></p>
    </div>

    <!-- Student Details Modal -->
    <div id="student-details-modal" class="modal">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-button" id="close-student-details-modal">&times;</button>
            <h3 class="text-2xl font-bold text-indigo-700 mb-4">Butiran Penglibatan Murid: <span id="modal-student-name" class="text-indigo-900"></span></h3>
            <div class="space-y-4">
                <p><strong>Jumlah Aktiviti Disertai:</strong> <span id="modal-total-activities" class="font-semibold"></span></p>
                <p><strong>Peringkat Tertinggi:</strong> <span id="modal-highest-level" class="font-semibold"></span></p>
                <p><strong>Pencapaian Terbaik:</strong> <span id="modal-best-achievement" class="font-semibold"></span></p>
                <h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Rekod Penyertaan:</h4>
                <div id="modal-student-records" class="space-y-3 text-sm">
                    <!-- Student's records will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Records Modal -->
    <div id="teacher-records-modal" class="modal">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-button" id="close-teacher-records-modal">&times;</button>
            <h3 class="text-2xl font-bold text-indigo-700 mb-4">Rekod Pengisian Guru: <span id="modal-teacher-name" class="text-indigo-900"></span></h3>
            <div class="space-y-4">
                <div id="modal-teacher-records" class="space-y-3 text-sm">
                    <!-- Teacher's records will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl border border-indigo-100">
        <h1 class="text-4xl font-extrabold text-center text-indigo-800 mb-4 tracking-tight">Sistem KoAktif!</h1>
        <p class="text-center text-gray-600 mb-8 text-lg">SJKC Kg Baru Pajam</p>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center text-gray-500 mb-4 py-8">
            <div class="flex items-center justify-center space-x-2">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                <span>Memuatkan aplikasi...</span>
            </div>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="hidden">
            <div class="mb-8">
                <img src="https://i.postimg.cc/D4W03LQC/logo-SJKC-KGB-PAJAM.png" alt="SJKC Kg Baru Pajam Logo" class="mx-auto block w-32 h-32 object-contain rounded-full shadow-lg">
            </div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Log Masuk / Daftar</h2>
            <div class="space-y-5 max-w-sm mx-auto">
                <input type="email" id="auth-email" placeholder="Emel Guru"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-150">
                <input type="password" id="auth-password" placeholder="Kata Laluan"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-150">
                <button id="login-button"
                        class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 shadow-md hover:shadow-lg transition-all duration-150 ease-in-out">
                    Log Masuk
                </button>
                <button id="signup-button"
                        class="w-full px-6 py-3 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 shadow-md hover:shadow-lg transition-all duration-150 ease-in-out">
                    Daftar Akaun Baru
                </button>
                <button id="forgot-password-button"
                        class="w-full text-sm text-indigo-600 hover:underline mt-2">
                    Lupa Kata Laluan?
                </button>
            </div>
        </div>

        <!-- Main Application Section (after authentication) -->
        <div id="main-app-section" class="hidden">
            <div id="auth-status" class="bg-indigo-50 border-l-4 border-indigo-400 text-indigo-800 p-4 mb-6 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm">
                <div class="mb-2 sm:mb-0">
                    <p class="text-sm">Log masuk sebagai: <span id="user-email" class="font-semibold text-indigo-900"></span></p>
                    <p class="text-xl text-indigo-800 font-bold mt-1">Selamat datang, <span id="logged-in-guru-name"></span>!</p>
                </div>
                <button id="logout-button" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-md transition duration-150 ease-in-out">
                    Log Keluar
                </button>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex border-b-2 border-indigo-200 mb-8 bg-indigo-100 rounded-t-lg shadow-md">
                <button id="nav-data-entry" class="tab-button active flex-1 py-3 px-2 text-center text-sm font-semibold text-gray-700 rounded-t-lg hover:bg-indigo-200 transition duration-150">
                    Pengisian Maklumat Pertandingan
                </button>
                <button id="nav-student-dashboard" class="tab-button flex-1 py-3 px-2 text-center text-sm font-semibold text-gray-700 rounded-t-lg hover:bg-indigo-200 transition duration-150">
                    Papan Pemuka Murid
                </button>
                <button id="nav-teacher-dashboard" class="tab-button flex-1 py-3 px-2 text-center text-sm font-semibold text-gray-700 rounded-t-lg hover:bg-indigo-200 transition duration-150">
                    Papan Pemuka Guru
                </button>
            </div>

            <!-- Content Areas -->
            <div id="content-data-entry" class="content-area">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-3">Pengisian Maklumat Pertandingan</h2>
                <div class="space-y-5">
                    <div>
                        <label for="record-sesi" class="block text-gray-700 text-sm font-bold mb-2">Sesi Akademik:</label>
                        <input type="text" id="record-sesi" placeholder="Sesi Akademik (contoh: 2024)"
                               class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="record-nama-guru" class="block text-gray-700 text-sm font-bold mb-2">Nama Guru Penasihat:</label>
                        <input type="text" id="record-nama-guru" placeholder="Nama Guru Penasihat"
                               class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" readonly>
                    </div>
                    <div>
                        <label for="record-nama-pertandingan" class="block text-gray-700 text-sm font-bold mb-2">Nama Pertandingan:</label>
                        <input type="text" id="record-nama-pertandingan" placeholder="Nama Pertandingan"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-150 uppercase">
                    </div>
                    
                    <div class="mb-4">
                        <label for="kategori-select" class="block text-gray-700 text-sm font-bold mb-2">Kategori:</label>
                        <select id="kategori-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-150">
                            <option value="">Pilih Kategori</option>
                            <option value="Kelab dan Persatuan">Kelab dan Persatuan</option>
                            <option value="Unit Beruniform">Unit Beruniform</option>
                            <option value="Sukan dan Permainan">Sukan dan Permainan</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="peringkat-select" class="block text-gray-700 text-sm font-bold mb-2">Peringkat:</label>
                        <select id="peringkat-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-150">
                            <option value="">Pilih Peringkat</option>
                            <option value="Sekolah">Sekolah</option>
                            <option value="Daerah">Daerah</option>
                            <option value="Negeri">Negeri</option>
                            <option value="Kebangsaan">Kebangsaan</option>
                            <option value="Antarabangsa">Antarabangsa</option>
                        </select>
                    </div>

                    <div class="border border-indigo-200 rounded-xl p-5 bg-indigo-50 shadow-inner">
                        <h3 class="text-lg font-semibold text-indigo-800 mb-3">Tambah Murid</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                            <select id="temp-kelas-murid" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-150">
                                <option value="">Pilih Kelas</option>
                                <option value="4A">4A</option>
                                <option value="5A">5A</option>
                                <option value="6A">6A</option>
                            </select>
                            <select id="temp-nama-murid" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-150 col-span-2">
                                <option value="">Pilih Murid</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <select id="temp-pencapaian-murid" class="col-span-3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-150">
                                <option value="">Pilih Pencapaian</option>
                                <option value="Tempat Pertama">Tempat Pertama</option>
                                <option value="Tempat Kedua">Tempat Kedua</option>
                                <option value="Tempat Ketiga">Tempat Ketiga</option>
                                <option value="Tempat Keempat">Tempat Keempat</option>
                                <option value="Tempat Kelima">Tempat Kelima</option>
                                <option value="Penyertaan">Penyertaan</option>
                            </select>
                            <button id="add-temp-murid-button"
                                    class="col-span-3 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md hover:shadow-lg transition-all duration-150 ease-in-out">
                                + Tambah Murid
                            </button>
                        </div>
                        <div id="added-murid-list" class="space-y-3 mt-4">
                            <!-- Dynamically added students will appear here -->
                            <p class="text-sm text-gray-500" id="no-murid-added-text">Tiada murid ditambah lagi.</p>
                        </div>
                    </div>
                    
                    <button id="add-record-button"
                            class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-all duration-150 ease-in-out transform hover:-translate-y-0.5">
                        Tambah Rekod Penyertaan
                    </button>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mt-10 mb-5 border-b pb-3">Rekod Penyertaan Tersimpan</h3>
                <div class="relative min-h-[200px] flex items-center justify-center">
                    <button id="prev-record-button" class="carousel-nav-button absolute left-0 z-10 p-3 rounded-r-none">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div id="current-record-display" class="flex-grow flex items-center justify-center p-4">
                        <p class="text-gray-500 text-center">Tiada rekod penyertaan dimuatkan.</p>
                    </div>
                    <button id="next-record-button" class="carousel-nav-button absolute right-0 z-10 p-3 rounded-l-none">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <p id="record-count-display" class="text-center text-sm text-gray-600 mt-2">
                    <!-- Example: 1 dari 5 rekod -->
                </p>
            </div>

            <!-- Student Dashboard Content -->
            <div id="content-student-dashboard" class="content-area hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-3">Papan Pemuka Murid</h2>
                <div class="space-y-6">
                    <!-- Filter Section -->
                    <div class="p-5 bg-indigo-50 rounded-xl shadow-inner">
                        <h3 class="text-lg font-semibold text-indigo-800 mb-3">Tapis Rekod Murid</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <select id="filter-kelas" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Kelas</option>
                                <option value="4A">4A</option>
                                <option value="5A">5A</option>
                                <option value="6A">6A</option>
                            </select>
                            <select id="filter-kategori" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Kategori</option>
                                <option value="Kelab dan Persatuan">Kelab dan Persatuan</option>
                                <option value="Unit Beruniform">Unit Beruniform</option>
                                <option value="Sukan dan Permainan">Sukan dan Permainan</option>
                            </select>
                            <input type="text" id="filter-student-name" placeholder="Cari Nama Murid"
                                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="apply-filter-button" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md">
                            Terapkan Penapis
                        </button>
                    </div>

                    <!-- Filtered Student List (Table) -->
                    <div class="p-5 bg-white rounded-xl shadow-md border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Senarai Murid (Bertapis)</h3>
                        <div class="overflow-x-auto">
                            <table class="student-table">
                                <thead>
                                    <tr>
                                        <th>Nama Murid</th>
                                        <th>Kelas</th>
                                        <th>Peringkat Tertinggi</th>
                                        <th>Pencapaian Terbaik</th>
                                        <th>Jumlah Penyertaan</th>
                                    </tr>
                                </thead>
                                <tbody id="filtered-students-table-body">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <p id="no-filtered-students-text" class="text-gray-500 text-center mt-4 hidden">Tiada murid ditemui berdasarkan penapis.</p>
                    </div>
                </div>
            </div>

            <!-- Teacher Dashboard Content -->
            <div id="content-teacher-dashboard" class="content-area hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-3">Papan Pemuka Guru</h2>
                <div class="space-y-6">
                    <!-- Filter Section for Teachers -->
                    <div class="p-5 bg-indigo-50 rounded-xl shadow-inner">
                        <h3 class="text-lg font-semibold text-indigo-800 mb-3">Tapis Rekod Guru</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <select id="filter-sesi-guru" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Semua Sesi Akademik</option>
                                <!-- Populated dynamically -->
                            </select>
                            <input type="text" id="filter-teacher-name" placeholder="Cari Nama Guru"
                                   class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="apply-teacher-filter-button" class="mt-4 w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md">
                            Terapkan Penapis Guru
                        </button>
                    </div>

                    <!-- Teacher List (Table) -->
                    <div class="p-5 bg-white rounded-xl shadow-md border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Senarai Guru (Bertapis)</h3>
                        <div class="overflow-x-auto">
                            <table class="teacher-table">
                                <thead>
                                    <tr>
                                        <th>Nama Guru</th>
                                        <th>Emel Guru</th>
                                        <th>Pengisian Terakhir</th>
                                        <th>Jumlah Rekod Aktiviti</th>
                                        <th>Jumlah Murid Direkodkan</th>
                                        <th>Tindakan</th>
                                    </tr>
                                </thead>
                                <tbody id="teacher-stats-table-body">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <p id="no-filtered-teachers-text" class="text-gray-500 text-center mt-4 hidden">Tiada guru ditemui berdasarkan penapis.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs - ALWAYS use these specific URLs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp,
            Timestamp,
            getDocs,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration - replace YOUR_WEB_APP_ID_HERE with your actual App ID from Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyA-gVaXnHUTT5s8jdi90X4Elfurd4i8rKk",
            authDomain: "pajsk-sjkckgbp.firebaseapp.com",
            projectId: "pajsk-sjkckgbp",
            storageBucket: "pajsk-sjkckgbp.appspot.com",
            messagingSenderId: "987908268258",
            appId: "1:987908268258:web:YOUR_WEB_APP_ID_HERE" // !!! PENTING: Gantikan ini dengan Web App ID sebenar anda dari Konsol Firebase !!!
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Sound Effects Setup (Tone.js) ---
        // Basic Synth for general clicks
        const clickSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.1 },
            volume: -10
        }).toDestination();

        // Synth for success notifications
        const successSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 },
            volume: -8
        }).toDestination();

        // Synth for error notifications
        const errorSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sawtooth" },
            envelope: { attack: 0.01, decay: 0.3, sustain: 0.05, release: 0.3 },
            volume: -7
        }).toDestination();

        async function playSound(type) {
            // Ensure audio context is started on user interaction
            await Tone.start(); 
            if (type === 'click') {
                clickSynth.triggerAttackRelease("C4", "8n");
            } else if (type === 'success') {
                successSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
            } else if (type === 'error') {
                errorSynth.triggerAttackRelease(["C3", "F#3"], "8n");
            }
        }

        // UI Elements (Existing)
        const loadingIndicator = document.getElementById('loading-indicator');
        const authSection = document.getElementById('auth-section');
        const mainAppSection = document.getElementById('main-app-section');

        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const forgotPasswordButton = document.getElementById('forgot-password-button');

        const userEmailSpan = document.getElementById('user-email');
        const loggedInGuruNameSpan = document.getElementById('logged-in-guru-name');
        const logoutButton = document.getElementById('logout-button');

        const navDataEntry = document.getElementById('nav-data-entry');
        const navStudentDashboard = document.getElementById('nav-student-dashboard');
        const navTeacherDashboard = document.getElementById('nav-teacher-dashboard');

        const contentDataEntry = document.getElementById('content-data-entry');
        const contentStudentDashboard = document.getElementById('content-student-dashboard');
        const contentTeacherDashboard = document.getElementById('content-teacher-dashboard');

        const recordSesiInput = document.getElementById('record-sesi');
        const recordNamaGuruInput = document.getElementById('record-nama-guru');
        const recordNamaPertandinganInput = document.getElementById('record-nama-pertandingan');
        
        const kategoriSelect = document.getElementById('kategori-select');
        const peringkatSelect = document.getElementById('peringkat-select');

        const tempKelasMuridInput = document.getElementById('temp-kelas-murid');
        const tempNamaMuridInput = document.getElementById('temp-nama-murid');
        const tempPencapaianMuridInput = document.getElementById('temp-pencapaian-murid');
        const addTempMuridButton = document.getElementById('add-temp-murid-button');
        const addedMuridListDiv = document.getElementById('added-murid-list');
        const noMuridAddedText = document.getElementById('no-murid-added-text');

        const addRecordButton = document.getElementById('add-record-button');
        
        const currentRecordDisplay = document.getElementById('current-record-display');
        const prevRecordButton = document.getElementById('prev-record-button');
        const nextRecordButton = document.getElementById('next-record-button');
        const recordCountDisplay = document.getElementById('record-count-display');

        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // UI Elements (Dashboards)
        const filterKelasSelect = document.getElementById('filter-kelas');
        const filterKategoriSelect = document.getElementById('filter-kategori');
        const filterStudentNameInput = document.getElementById('filter-student-name');
        const applyFilterButton = document.getElementById('apply-filter-button');
        const filteredStudentsTableBody = document.getElementById('filtered-students-table-body');
        const noFilteredStudentsText = document.getElementById('no-filtered-students-text');

        const studentDetailsModal = document.getElementById('student-details-modal');
        const closeStudentDetailsModalButton = document.getElementById('close-student-details-modal');
        const modalStudentNameSpan = document.getElementById('modal-student-name');
        const modalTotalActivitiesSpan = document.getElementById('modal-total-activities');
        const modalHighestLevelSpan = document.getElementById('modal-highest-level');
        const modalBestAchievementSpan = document.getElementById('modal-best-achievement');
        const modalStudentRecordsDiv = document.getElementById('modal-student-records');

        const teacherRecordsModal = document.getElementById('teacher-records-modal'); // New modal for teacher records
        const closeTeacherRecordsModalButton = document.getElementById('close-teacher-records-modal');
        const modalTeacherNameSpan = document.getElementById('modal-teacher-name'); // For teacher modal title
        const modalTeacherRecordsDiv = document.getElementById('modal-teacher-records'); // For teacher modal content

        const filterSesiGuruSelect = document.getElementById('filter-sesi-guru'); // New filter for teacher dashboard
        const filterTeacherNameInput = document.getElementById('filter-teacher-name');
        const applyTeacherFilterButton = document.getElementById('apply-teacher-filter-button');
        const teacherStatsTableBody = document.getElementById('teacher-stats-table-body'); // Changed to table body
        const noFilteredTeachersText = document.getElementById('no-filtered-teachers-text'); // New for teacher dashboard

        let currentUser = null;
        let currentStudentsForRecord = [];
        let allMuridData = []; // Cached murid data
        let allRecords = []; // All records fetched from Firestore for various displays
        let allGuruData = []; // Cached guru data
        let currentRecordIndex = 0; // Index for the current record displayed in carousel

        // Define achievement and level ranking for logic
        // Lower number for achievementRank means better achievement (e.g., 1st is best)
        const achievementRank = {
            "Tempat Pertama": 1,
            "Tempat Kedua": 2,
            "Tempat Ketiga": 3,
            "Tempat Keempat": 4,
            "Tempat Kelima": 5,
            "Penyertaan": 6 
        };

        // Higher number for levelRank means higher level (e.g., Antarabangsa is highest)
        const levelRank = {
            "Sekolah": 1,
            "Daerah": 2,
            "Negeri": 3,
            "Kebangsaan": 4,
            "Antarabangsa": 5
        };

        // --- Message Box Function ---
        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageBox.classList.remove('error');
            if (isError) {
                messageBox.classList.add('error');
                playSound('error'); // Play error sound
            } else {
                playSound('success'); // Play success sound
            }
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // --- Navigation Logic ---
        function showPage(pageId) {
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(`nav-${pageId.replace('content-', '')}`).classList.add('active');

            // Call render functions when tabs are switched
            if (pageId === 'content-student-dashboard') {
                renderStudentDashboard();
            } else if (pageId === 'content-teacher-dashboard') {
                renderTeacherDashboard();
            }
        }

        // --- Fetch Guru Name and Auto-fill (for logged in user) ---
        async function fetchAndSetGuruName(email) {
            try {
                const q = query(collection(db, "guru"), where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const guruData = querySnapshot.docs[0].data();
                    loggedInGuruNameSpan.textContent = guruData.nama || 'Nama Guru Tidak Diketahui';
                    recordNamaGuruInput.value = guruData.nama || '';
                } else {
                    loggedInGuruNameSpan.textContent = 'Nama Guru Tidak Ditemui dalam database';
                    recordNamaGuruInput.value = '';
                    showMessage("Profil guru tidak ditemui. Sila hubungi pentadbir untuk mendaftarkan emel anda dalam koleksi 'guru'.", true);
                }
            } catch (error) {
                console.error("Error fetching guru name:", error);
                loggedInGuruNameSpan.textContent = 'Ralat Memuatkan Nama Guru';
                recordNamaGuruInput.value = '';
                showMessage("Ralat memuatkan nama guru.", true);
            }
        }

        // --- Populate Murid Dropdown based on Kelas ---
        async function populateMuridDropdown(selectedKelas) {
            tempNamaMuridInput.innerHTML = '<option value="">Pilih Murid</option>';
            
            if (!selectedKelas) return;

            const filteredMurid = allMuridData.filter(murid => murid.kelas === selectedKelas);

            if (filteredMurid.length > 0) {
                filteredMurid.sort((a, b) => a.nama.localeCompare(b.nama));
                filteredMurid.forEach(muridData => {
                    const option = document.createElement('option');
                    option.value = muridData.nama;
                    option.textContent = muridData.nama;
                    tempNamaMuridInput.appendChild(option);
                });
            } else {
                showMessage(`Tiada murid ditemui untuk kelas ${selectedKelas}. Sila pastikan data murid lengkap.`, true);
            }
        }

        // --- Fetch All Murid Data (once on app load) ---
        async function fetchAllMuridData() {
            try {
                const querySnapshot = await getDocs(collection(db, "murid"));
                if (!querySnapshot.empty) {
                    allMuridData = querySnapshot.docs.map(doc => doc.data()); // Cache all murid data
                } else {
                    showMessage("Tiada rekod murid ditemui dalam Firestore. Sila tambah murid terlebih dahulu.", true);
                }
            } catch (error) {
                console.error("Error fetching murid data:", error);
                showMessage("Ralat memuatkan senarai murid.", true);
            }
        }

        // --- Fetch All Guru Data (once on app load for teacher dashboard) ---
        async function fetchAllGuruData() {
            try {
                const querySnapshot = await getDocs(collection(db, "guru"));
                if (!querySnapshot.empty) {
                    allGuruData = querySnapshot.docs.map(doc => doc.data()); // Cache all guru data
                } else {
                    showMessage("Tiada rekod guru ditemui dalam Firestore. Sila tambah guru terlebih dahulu.", true);
                }
            } catch (error) {
                console.error("Error fetching guru data:", error);
                showMessage("Ralat memuatkan senarai guru.", true);
            }
        }

        // --- Populate Sesi Akademik Filter for Teacher Dashboard ---
        function populateTeacherSesiFilter() {
            const uniqueSesi = new Set();
            allRecords.forEach(record => {
                if (record.sesi) uniqueSesi.add(record.sesi);
            });

            filterSesiGuruSelect.innerHTML = '<option value="">Semua Sesi Akademik</option>';
            Array.from(uniqueSesi).sort((a, b) => b.localeCompare(a)).forEach(sesi => { // Sort descending
                const option = document.createElement('option');
                option.value = sesi;
                option.textContent = sesi;
                filterSesiGuruSelect.appendChild(option);
            });

            // Set default to current year if available
            const currentYear = new Date().getFullYear().toString();
            if (uniqueSesi.has(currentYear)) {
                filterSesiGuruSelect.value = currentYear;
            } else if (filterSesiGuruSelect.options.length > 1) {
                filterSesiGuruSelect.value = filterSesiGuruSelect.options[1].value; // Select latest if current year not present
            }
        }

        // --- Firebase Authentication Listeners ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userEmailSpan.textContent = currentUser.email;
                authSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                showMessage(`Berjaya log masuk sebagai ${currentUser.email}.`);

                recordSesiInput.value = new Date().getFullYear().toString(); // Default current year
                await fetchAndSetGuruName(currentUser.email);
                await fetchAllMuridData(); // Load all murid data once
                await fetchAllGuruData(); // Load all guru data once

                showPage('content-data-entry');
                setupFirestoreListener(); // Start listening for records
            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                mainAppSection.classList.add('hidden');
                loadingIndicator.classList.add('hidden');
                showMessage("Sila log masuk untuk meneruskan.");
            }
        });

        // --- Authentication Event Listeners ---
        loginButton.addEventListener('click', async () => {
            playSound('click'); // Play click sound
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            if (!email || !password) {
                showMessage("Sila masukkan emel dan kata laluan.", true);
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(`Log masuk gagal: ${error.message}`, true);
            }
        });

        signupButton.addEventListener('click', async () => {
            playSound('click'); // Play click sound
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            if (!email || !password) {
                showMessage("Sila masukkan emel dan kata laluan.", true);
                return;
            }
            if (password.length < 6) {
                showMessage("Kata laluan mesti sekurang-kurangnya 6 aksara.", true);
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Pendaftaran berjaya! Anda kini log masuk.", false);
            } catch (error) {
                console.error("Sign up failed:", error);
                showMessage(`Pendaftaran gagal: ${error.message}`, true);
            }
        });

        forgotPasswordButton.addEventListener('click', async () => {
            playSound('click'); // Play click sound
            const email = authEmailInput.value.trim();
            if (!email) {
                showMessage("Sila masukkan emel anda untuk menetapkan semula kata laluan.", true);
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showMessage(`Pautan tetapan semula kata laluan telah dihantar ke ${email}. Sila semak emel anda.`, false);
            } catch (error) {
                console.error("Password reset failed:", error);
                showMessage(`Gagal menghantar pautan tetapan semula: ${error.message}`, true);
            }
        });

        logoutButton.addEventListener('click', async () => {
            playSound('click'); // Play click sound
            try {
                await signOut(auth);
                showMessage("Anda telah log keluar.");
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage(`Gagal log keluar: ${error.message}`, true);
            }
        });

        // --- Navigation Button Listeners ---
        navDataEntry.addEventListener('click', () => { playSound('click'); showPage('content-data-entry'); });
        navStudentDashboard.addEventListener('click', () => { playSound('click'); showPage('content-student-dashboard'); });
        navTeacherDashboard.addEventListener('click', () => { playSound('click'); showPage('content-teacher-dashboard'); });

        // --- Nama Pertandingan/Aktiviti Auto-capitalize ---
        recordNamaPertandinganInput.addEventListener('input', (event) => {
            event.target.value = event.target.value.toUpperCase();
        });

        // --- Temp Murid Select Handlers ---
        tempKelasMuridInput.addEventListener('change', () => {
            playSound('click'); // Play click sound
            const selectedKelas = tempKelasMuridInput.value;
            populateMuridDropdown(selectedKelas);
        });

        // --- Student List Management for Data Entry Form ---
        function updateAddedMuridList() {
            addedMuridListDiv.innerHTML = '';
            if (currentStudentsForRecord.length === 0) {
                noMuridAddedText.classList.remove('hidden');
            } else {
                noMuridAddedText.classList.add('hidden');
                currentStudentsForRecord.forEach((murid, index) => {
                    const muridItem = document.createElement('div');
                    muridItem.className = 'murid-item';
                    muridItem.innerHTML = `
                        <span>${murid.nama} (${murid.kelas}) - ${murid.pencapaian}</span>
                        <button class="remove-murid-button" data-index="${index}">&#x2715;</button>
                    `;
                    addedMuridListDiv.appendChild(muridItem);
                });

                document.querySelectorAll('.remove-murid-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        playSound('click'); // Play click sound for remove
                        const indexToRemove = parseInt(event.target.dataset.index);
                        currentStudentsForRecord.splice(indexToRemove, 1);
                        updateAddedMuridList();
                    });
                });
            }
        }

        addTempMuridButton.addEventListener('click', () => {
            playSound('click'); // Play click sound
            const nama = tempNamaMuridInput.value;
            const kelas = tempKelasMuridInput.value;
            const pencapaian = tempPencapaianMuridInput.value;

            if (!nama || !kelas || !pencapaian) {
                showMessage("Sila pilih Nama Murid, Kelas, dan Pencapaian.", true);
                return;
            }

            const isDuplicate = currentStudentsForRecord.some(student => student.nama === nama);
            if (isDuplicate) {
                showMessage(`Murid '${nama}' telah ditambah untuk rekod ini.`, true);
                return;
            }

            currentStudentsForRecord.push({ id: nama, nama, kelas, pencapaian });
            updateAddedMuridList();

            // Reset dropdowns after adding
            tempKelasMuridInput.value = '';
            tempNamaMuridInput.innerHTML = '<option value="">Pilih Murid</option>'; // Clear murid dropdown
            tempPencapaianMuridInput.value = '';
        });


        // --- Carousel Display Logic ---
        function displayCurrentRecord() {
            currentRecordDisplay.innerHTML = '';
            recordCountDisplay.textContent = '';

            if (allRecords.length === 0) {
                currentRecordDisplay.innerHTML = '<p class="text-gray-500 text-center">Tiada rekod penyertaan ditemui. Tambah satu di atas!</p>';
                prevRecordButton.disabled = true;
                nextRecordButton.disabled = true;
                return;
            }

            if (currentRecordIndex < 0) currentRecordIndex = 0;
            if (currentRecordIndex >= allRecords.length) currentRecordIndex = allRecords.length - 1;

            const record = allRecords[currentRecordIndex];
            const recordElement = document.createElement('div');
            recordElement.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-100 transform hover:scale-[1.01] transition-all duration-200 ease-in-out w-full';
            const timestamp = record.timestamp ? new Date(record.timestamp.toDate()).toLocaleString() : 'N/A';

            let studentsListHtml = '<ul class="list-disc list-inside mt-2 text-gray-700 space-y-1">';
            if (record.murid && Array.isArray(record.murid) && record.murid.length > 0) {
                record.murid.forEach(murid => {
                    studentsListHtml += `<li class="text-gray-800"><span class="font-medium">${murid.nama}</span> (${murid.kelas}) - Pencapaian: <span class="text-indigo-600 font-semibold">${murid.pencapaian}</span></li>`;
                });
            } else {
                studentsListHtml += '<li class="text-gray-500 italic">Tiada murid direkodkan.</li>';
            }
            studentsListHtml += '</ul>';

            recordElement.innerHTML = `
                <p class="font-extrabold text-xl text-indigo-700 mb-2">${record.namaPertandingan || 'N/A'}</p>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-700 text-sm">
                    <p><strong>Sesi Akademik:</strong> <span class="font-medium">${record.sesi || 'N/A'}</span></p>
                    <p><strong>Nama Guru:</strong> <span class="font-medium">${record.namaGuru || 'N/A'}</span></p>
                    <p><strong>Kategori:</strong> <span class="font-medium">${record.kategori || 'N/A'}</span></p>
                    <p><strong>Peringkat:</strong> <span class="font-medium">${record.peringkat || 'N/A'}</span></p>
                </div>
                <p class="font-semibold text-gray-800 mt-4 mb-2">Murid yang Terlibat:</p>
                ${studentsListHtml}
                <p class="text-gray-500 text-xs mt-3 border-t pt-2 border-gray-100">Ditambah oleh: ${record.createdBy || 'Tidak diketahui'} pada ${timestamp}</p>
            `;
            currentRecordDisplay.appendChild(recordElement);

            prevRecordButton.disabled = currentRecordIndex === 0;
            nextRecordButton.disabled = currentRecordIndex === allRecords.length - 1;
            recordCountDisplay.textContent = `${currentRecordIndex + 1} dari ${allRecords.length} rekod`;
        }

        // --- Carousel Navigation Event Listeners ---
        prevRecordButton.addEventListener('click', () => {
            playSound('click'); // Play click sound
            if (currentRecordIndex > 0) {
                currentRecordIndex--;
                displayCurrentRecord();
            }
        });

        nextRecordButton.addEventListener('click', () => {
            playSound('click'); // Play click sound
            if (currentRecordIndex < allRecords.length - 1) {
                currentRecordIndex++;
                displayCurrentRecord();
            }
        });

        // --- Firestore Listener for rekodPenyertaan (main data source) ---
        function setupFirestoreListener() {
            const q = query(collection(db, "rekodPenyertaan"), orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                allRecords = [];
                if (!snapshot.empty) {
                    snapshot.forEach((doc) => {
                        allRecords.push(doc.data());
                    });
                }
                currentRecordIndex = 0;
                displayCurrentRecord(); // Update data entry carousel

                // Also re-render dashboards with updated data
                renderStudentDashboard();
                renderTeacherDashboard(); // Re-render teacher dashboard when records change
                populateTeacherSesiFilter(); // Update sesi filter when records change
            }, (error) => {
                console.error("Error fetching PAJSK records: ", error);
                showMessage(`Ralat memuatkan data PAJSK: ${error.message}`, true);
                currentRecordDisplay.innerHTML = '<p class="text-red-500 text-center">Ralat memuatkan data PAJSK.</p>';
            });
        }

        // --- Add New Record Functionality ---
        addRecordButton.addEventListener('click', async () => {
            playSound('click'); // Play click sound
            const sesi = recordSesiInput.value.trim();
            const namaGuru = recordNamaGuruInput.value.trim();
            const namaPertandingan = recordNamaPertandinganInput.value.trim();
            const kategori = kategoriSelect.value;
            const peringkat = peringkatSelect.value;

            if (!currentUser) {
                showMessage("Sila log masuk untuk menambah rekod.", true);
                return;
            }

            if (!sesi || !namaGuru || !namaPertandingan || !kategori || !peringkat || currentStudentsForRecord.length === 0) {
                showMessage("Sila lengkapkan semua medan wajib (termasuk Kategori & Peringkat) dan tambah sekurang-kurangnya seorang murid.", true);
                return;
            }

            try {
                await addDoc(collection(db, "rekodPenyertaan"), {
                    sesi: sesi,
                    namaGuru: namaGuru,
                    namaPertandingan: namaPertandingan,
                    kategori: kategori,
                    peringkat: peringkat,
                    murid: currentStudentsForRecord,
                    userId: currentUser.uid,
                    createdBy: currentUser.email,
                    timestamp: serverTimestamp()
                });
                showMessage("Rekod penyertaan berjaya ditambah!");
                // Clear form fields
                recordSesiInput.value = new Date().getFullYear().toString();
                recordNamaPertandinganInput.value = '';
                kategoriSelect.value = '';
                peringkatSelect.value = '';

                currentStudentsForRecord = [];
                updateAddedMuridList();
                tempKelasMuridInput.value = '';
                tempNamaMuridInput.innerHTML = '<option value="">Pilih Murid</option>';
                tempPencapaianMuridInput.value = '';
            } catch (error) {
                console.error("Error adding PAJSK record: ", error);
                showMessage(`Gagal menambah rekod: ${error.message}. Sila semak konsol untuk butiran.`, true);
            }
        });

        // --- Student Dashboard Logic ---
        function renderStudentDashboard() {
            const filteredRecords = applyStudentFilters();
            const studentSummary = {}; // Will hold aggregated data for each student

            filteredRecords.forEach(record => {
                record.murid.forEach(murid => {
                    const studentKey = `${murid.nama}-${murid.kelas}`; // Unique key for student
                    if (!studentSummary[studentKey]) {
                        studentSummary[studentKey] = {
                            nama: murid.nama,
                            kelas: murid.kelas,
                            totalParticipations: 0,
                            highestLevel: null, // Stores the level string, e.g., "Antarabangsa"
                            highestLevelRank: 0, // Stores the rank number of the highest level
                            bestAchievementWithLevel: 'Tiada', // e.g., "Kebangsaan Tempat Pertama"
                            bestAchievementRank: Infinity, // Lower is better
                            bestAchievementLevelRank: 0, // Higher is better (for tie-breaking on achievement)
                            allRecords: [] // To store full records for modal display
                        };
                    }

                    // Update total participations
                    studentSummary[studentKey].totalParticipations++;

                    // Update highest level
                    if (record.peringkat && levelRank[record.peringkat] !== undefined) {
                        const currentRecordLevelRank = levelRank[record.peringkat];
                        if (currentRecordLevelRank > studentSummary[studentKey].highestLevelRank) {
                            studentSummary[studentKey].highestLevelRank = currentRecordLevelRank;
                            studentSummary[studentKey].highestLevel = record.peringkat;
                        }
                    }

                    // Update best achievement (excluding "Penyertaan")
                    if (murid.pencapaian && achievementRank[murid.pencapaian] !== undefined && murid.pencapaian !== "Penyertaan") {
                        const currentAchievementRank = achievementRank[murid.pencapaian];
                        const currentLevelRankForAchievement = levelRank[record.peringkat];

                        // Is this achievement better than the current best?
                        if (currentAchievementRank < studentSummary[studentKey].bestAchievementRank) {
                            // Yes, update everything
                            studentSummary[studentKey].bestAchievementRank = currentAchievementRank;
                            studentSummary[studentKey].bestAchievementLevelRank = currentLevelRankForAchievement;
                            studentSummary[studentKey].bestAchievementWithLevel = `${record.peringkat} ${murid.pencapaian}`;
                        } else if (currentAchievementRank === studentSummary[studentKey].bestAchievementRank) {
                            // Same achievement rank, check if current level is higher (better)
                            if (currentLevelRankForAchievement > studentSummary[studentKey].bestAchievementLevelRank) {
                                // Yes, same achievement but better level, update
                                studentSummary[studentKey].bestAchievementLevelRank = currentLevelRankForAchievement;
                                studentSummary[studentKey].bestAchievementWithLevel = `${record.peringkat} ${murid.pencapaian}`;
                            }
                        }
                    }

                    // Store all records for modal
                    studentSummary[studentKey].allRecords.push({
                        namaPertandingan: record.namaPertandingan,
                        kategori: record.kategori,
                        peringkat: record.peringkat,
                        pencapaian: murid.pencapaian,
                        sesi: record.sesi,
                        namaGuru: record.namaGuru,
                        timestamp: record.timestamp ? record.timestamp.toDate() : null // Include timestamp for sorting
                    });
                });
            });

            filteredStudentsTableBody.innerHTML = ''; // Clear existing table rows
            noFilteredStudentsText.classList.add('hidden'); // Hide no data message by default

            const studentsArray = Object.values(studentSummary).sort((a, b) => a.nama.localeCompare(b.nama));

            if (studentsArray.length === 0) {
                noFilteredStudentsText.classList.remove('hidden'); // Show no data message
            } else {
                studentsArray.forEach(student => {
                    const tableRow = document.createElement('tr');
                    tableRow.className = 'hover:bg-gray-100 cursor-pointer';
                    tableRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.highestLevel || 'Tiada'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.bestAchievementWithLevel || 'Tiada'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.totalParticipations}</td>
                    `;
                    tableRow.addEventListener('click', () => showStudentDetailsModal(student));
                    filteredStudentsTableBody.appendChild(tableRow);
                });
            }
        }

        function applyStudentFilters() {
            let filtered = allRecords;

            const selectedKelas = filterKelasSelect.value;
            const selectedKategori = filterKategoriSelect.value;
            const studentNameSearch = filterStudentNameInput.value.trim().toLowerCase();

            if (selectedKelas) {
                filtered = filtered.filter(record => 
                    record.murid.some(m => m.kelas === selectedKelas)
                );
            }
            if (selectedKategori) {
                filtered = filtered.filter(record => record.kategori === selectedKategori);
            }
            if (studentNameSearch) {
                filtered = filtered.filter(record => 
                    record.murid.some(m => m.nama.toLowerCase().includes(studentNameSearch))
                );
            }
            return filtered;
        }

        applyFilterButton.addEventListener('click', () => { playSound('click'); renderStudentDashboard(); }); // Re-render on filter click

        function showStudentDetailsModal(studentData) {
            modalStudentNameSpan.textContent = studentData.nama;
            modalTotalActivitiesSpan.textContent = studentData.totalParticipations; // Use totalParticipations
            modalHighestLevelSpan.textContent = studentData.highestLevel || 'Tiada'; // Display highest level
            modalBestAchievementSpan.textContent = studentData.bestAchievementWithLevel || 'Tiada'; // Display best achievement (with level)

            modalStudentRecordsDiv.innerHTML = '';
            if (studentData.allRecords && studentData.allRecords.length > 0) { // Use allRecords from studentSummary
                // Sort records in modal by timestamp (most recent first)
                studentData.allRecords.sort((a, b) => {
                    const dateA = a.timestamp || new Date(0);
                    const dateB = b.timestamp || new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });

                studentData.allRecords.forEach(record => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'bg-blue-50 p-3 rounded-md border border-blue-100';
                    const timestampStr = record.timestamp ? record.timestamp.toLocaleString() : 'N/A';
                    recordItem.innerHTML = `
                        <p class="font-medium">${record.namaPertandingan}</p>
                        <p class="text-xs text-gray-700">Sesi: ${record.sesi} | Kategori: ${record.kategori} | Peringkat: ${record.peringkat}</p>
                        <p class="text-sm text-indigo-700 font-semibold">Pencapaian: ${record.pencapaian}</p>
                        <p class="text-xs text-gray-500">Guru: ${record.namaGuru}</p>
                        <p class="text-xs text-gray-500">Tarikh Rekod: ${timestampStr}</p>
                    `;
                    modalStudentRecordsDiv.appendChild(recordItem);
                });
            } else {
                modalStudentRecordsDiv.innerHTML = '<p class="text-gray-500">Tiada rekod penglibatan ditemui.</p>';
            }

            studentDetailsModal.classList.add('show');
        }

        closeStudentDetailsModalButton.addEventListener('click', () => {
            playSound('click'); // Play click sound
            studentDetailsModal.classList.remove('show');
        });

        // --- Teacher Dashboard Logic ---
        function renderTeacherDashboard() {
            teacherStatsTableBody.innerHTML = ''; // Clear table
            noFilteredTeachersText.classList.add('hidden'); // Hide no data message

            const teacherFilterSesi = filterSesiGuruSelect.value;
            const teacherNameSearch = filterTeacherNameInput.value.trim().toLowerCase();

            const teacherStats = {};

            // Start with all guru data
            // Use a Set to track processed emails to avoid duplicates
            const processedEmails = new Set(); 

            // Aggregate stats from records based on filters
            allRecords.forEach(record => {
                const teacherEmail = record.createdBy;
                
                // Apply sesi filter from teacher dashboard
                if (teacherFilterSesi && record.sesi !== teacherFilterSesi) {
                    return; // Skip if session doesn't match filter
                }

                if (!teacherStats[teacherEmail]) {
                    teacherStats[teacherEmail] = {
                        email: teacherEmail,
                        name: allGuruData.find(g => g.email === teacherEmail)?.nama || teacherEmail,
                        totalActivities: 0,
                        totalStudentsParticipated: 0,
                        lastRecordDate: null,
                        recordsByTeacher: [] // Store records for detailed view
                    };
                    processedEmails.add(teacherEmail);
                }
                teacherStats[teacherEmail].totalActivities++;
                teacherStats[teacherEmail].totalStudentsParticipated += record.murid.length;
                
                // Update last record date
                const recordTimestamp = record.timestamp ? record.timestamp.toDate() : new Date(0); // Use epoch for missing timestamp
                if (!teacherStats[teacherEmail].lastRecordDate || recordTimestamp > teacherStats[teacherEmail].lastRecordDate) {
                    teacherStats[teacherEmail].lastRecordDate = recordTimestamp;
                }
                teacherStats[teacherEmail].recordsByTeacher.push(record); // Add record for detailed view
            });

            // Include teachers from `guru` collection who might not have any records matching the filters
            // Or who simply haven't recorded anything yet but are in the guru list
            allGuruData.forEach(guru => {
                if (!processedEmails.has(guru.email)) { // Only add if not already processed from records
                    teacherStats[guru.email] = {
                        email: guru.email,
                        name: guru.nama,
                        totalActivities: 0,
                        totalStudentsParticipated: 0,
                        lastRecordDate: null,
                        recordsByTeacher: []
                    };
                    processedEmails.add(guru.email);
                }
            });


            const teachersToDisplay = Object.values(teacherStats).sort((a, b) => a.name.localeCompare(b.name));

            // Apply teacher name search filter after initial aggregation
            const finalTeachers = teachersToDisplay.filter(teacher => {
                return (teacher.name && teacher.name.toLowerCase().includes(teacherNameSearch)) || (teacher.email && teacher.email.toLowerCase().includes(teacherNameSearch));
            });


            if (finalTeachers.length === 0) {
                noFilteredTeachersText.classList.remove('hidden');
            } else {
                finalTeachers.forEach(teacher => {
                    const tableRow = document.createElement('tr');
                    tableRow.className = 'hover:bg-gray-100';
                    tableRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${teacher.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${teacher.lastRecordDate ? teacher.lastRecordDate.toLocaleString() : 'Tiada'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${teacher.totalActivities}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${teacher.totalStudentsParticipated}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button class="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-md hover:bg-blue-600 transition-colors duration-150 view-teacher-data"
                                    data-teacher-email="${teacher.email}" data-teacher-name="${teacher.name}">
                                Semak Data
                            </button>
                        </td>
                    `;
                    teacherStatsTableBody.appendChild(tableRow);
                });

                // Attach event listeners for 'Semak Data' buttons
                document.querySelectorAll('.view-teacher-data').forEach(button => {
                    button.addEventListener('click', (event) => {
                        playSound('click'); // Play click sound
                        const email = event.target.dataset.teacherEmail;
                        const name = event.target.dataset.teacherName;
                        showTeacherRecordsModal(email, name);
                    });
                });
            }
        }

        filterSesiGuruSelect.addEventListener('change', () => { playSound('click'); renderTeacherDashboard(); });
        applyTeacherFilterButton.addEventListener('click', () => { playSound('click'); renderTeacherDashboard(); });

        function showTeacherRecordsModal(teacherEmail, teacherName) {
            modalTeacherNameSpan.textContent = teacherName;
            modalTeacherRecordsDiv.innerHTML = '<p class="text-gray-500">Memuatkan rekod...</p>';

            const recordsForTeacher = allRecords.filter(record => record.createdBy === teacherEmail);

            modalTeacherRecordsDiv.innerHTML = ''; // Clear previous content

            if (recordsForTeacher.length > 0) {
                // Sort records by timestamp (most recent first)
                recordsForTeacher.sort((a, b) => {
                    const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });

                recordsForTeacher.forEach(record => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'bg-blue-50 p-3 rounded-md border border-blue-100 mb-3';
                    const timestampStr = record.timestamp ? new Date(record.timestamp.toDate()).toLocaleString() : 'N/A';
                    
                    let studentsListHtml = '<ul class="list-disc list-inside mt-2 text-gray-700 space-y-1">';
                    if (record.murid && Array.isArray(record.murid) && record.murid.length > 0) {
                        record.murid.forEach(murid => {
                            studentsListHtml += `<li class="text-gray-800"><span class="font-medium">${murid.nama}</span> (${murid.kelas}) - Pencapaian: <span class="text-indigo-600 font-semibold">${murid.pencapaian}</span></li>`;
                        });
                    } else {
                        studentsListHtml += '<li class="text-gray-500 italic">Tiada murid direkodkan.</li>';
                    }
                    studentsListHtml += '</ul>';

                    recordItem.innerHTML = `
                        <p class="font-extrabold text-lg text-indigo-700 mb-1">${record.namaPertandingan || 'N/A'}</p>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-700 text-xs">
                            <p><strong>Sesi Akademik:</strong> <span class="font-medium">${record.sesi || 'N/A'}</span></p>
                            <p><strong>Kategori:</strong> <span class="font-medium">${record.kategori || 'N/A'}</span></p>
                            <p><strong>Peringkat:</strong> <span class="font-medium">${record.peringkat || 'N/A'}</span></p>
                            <p><strong>Tarikh Rekod:</strong> <span class="font-medium">${timestampStr}</span></p>
                        </div>
                        <p class="font-semibold text-gray-800 mt-3 mb-1">Murid yang Terlibat:</p>
                        ${studentsListHtml}
                    `;
                    modalTeacherRecordsDiv.appendChild(recordItem);
                });
            } else {
                modalTeacherRecordsDiv.innerHTML = '<p class="text-gray-500">Tiada rekod pengisian ditemui untuk guru ini.</p>';
            }

            teacherRecordsModal.classList.add('show');
        }

        closeTeacherRecordsModalButton.addEventListener('click', () => {
            playSound('click'); // Play click sound
            teacherRecordsModal.classList.remove('show');
        });

    </script>
</body>
</html>
